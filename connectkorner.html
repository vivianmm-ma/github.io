<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Korner Forum</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase services
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let user = null;

        document.addEventListener('DOMContentLoaded', () => {
            const messagesContainer = document.getElementById('messages-container');
            const postForm = document.getElementById('post-form');
            const messageInput = document.getElementById('message-input');
            const authContainer = document.getElementById('auth-container');
            const signInButton = document.getElementById('sign-in-button');
            const signOutButton = document.getElementById('sign-out-button');
            const userInfo = document.getElementById('user-info');
            const errorBox = document.getElementById('error-box');

            function showMessage(message, type = 'error') {
                errorBox.textContent = message;
                errorBox.className = `p-4 rounded-lg text-white text-center mb-4 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
                errorBox.style.display = 'block';
                setTimeout(() => errorBox.style.display = 'none', 5000);
            }

            onAuthStateChanged(auth, (currentUser) => {
                user = currentUser;
                if (user) {
                    authContainer.classList.remove('hidden');
                    signInButton.classList.add('hidden');
                    userInfo.textContent = `Signed in as: ${user.displayName || user.email}`;
                    postForm.classList.remove('hidden');
                    
                    // Setup real-time listener for posts
                    const postsCollection = collection(db, `artifacts/${appId}/public/data/forum-posts`);
                    const postsQuery = query(postsCollection, orderBy('createdAt', 'desc'));

                    onSnapshot(postsQuery, (snapshot) => {
                        messagesContainer.innerHTML = '';
                        if (snapshot.empty) {
                            messagesContainer.innerHTML = '<div class="text-center text-gray-400 p-8">No posts yet. Be the first to start a conversation!</div>';
                        } else {
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                const messageElement = document.createElement('div');
                                messageElement.className = "bg-gray-800 p-4 rounded-lg shadow-md border border-gray-700 mb-4";
                                messageElement.innerHTML = `
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-semibold text-purple-400">${data.user}</span>
                                        ${data.createdAt ? `<span class="text-sm text-gray-500">${new Date(data.createdAt.seconds * 1000).toLocaleTimeString()}</span>` : ''}
                                    </div>
                                    <p class="text-gray-300">${data.text}</p>
                                `;
                                messagesContainer.appendChild(messageElement);
                            });
                        }
                    }, (e) => {
                        console.error("Error fetching data:", e);
                        showMessage("Failed to load posts. Please check your network connection.");
                    });
                } else {
                    authContainer.classList.add('hidden');
                    signInButton.classList.remove('hidden');
                    userInfo.textContent = '';
                    postForm.classList.add('hidden');
                    messagesContainer.innerHTML = '<div class="text-center text-gray-400 p-8">Please sign in to view and post messages.</div>';
                }
            });

            signInButton.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, provider);
                } catch (e) {
                    console.error("Error during Google Sign-in:", e);
                    showMessage("Failed to sign in. Please try again.");
                }
            });

            signOutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    messagesContainer.innerHTML = ''; 
                } catch (e) {
                    console.error("Error during sign out:", e);
                    showMessage("Failed to sign out. Please try again.");
                }
            });

            postForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = messageInput.value.trim();
                if (text === '') {
                    showMessage("Message cannot be empty.");
                    return;
                }
                
                if (!user) {
                    showMessage("You must be signed in to post.");
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/forum-posts`), {
                        text: text,
                        user: user.displayName || user.email,
                        userId: user.uid,
                        createdAt: serverTimestamp(),
                    });
                    messageInput.value = '';
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showMessage("Failed to post message. Please try again.");
                }
            });
        });
    </script>
    <style>
        body {
            background-color: #0d0f1a;
            color: #ecf0f1;
            font-family: 'Source Serif Pro', serif;
        }
        .message-box {
          position: fixed;
          top: 1rem;
          left: 50%;
          transform: translateX(-50%);
          z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4 sm:p-8">
    <div class="max-w-4xl mx-auto flex flex-col min-h-screen">
        <div id="error-box" class="message-box hidden"></div>
        <a href="index.html" class="mb-4 text-sm text-gray-400 hover:underline">‚Üê Back to Home</a>
        <h1 class="text-3xl font-bold text-white mb-6 text-center">Connect Korner Forum</h1>

        <div id="auth-container" class="mb-4 flex items-center justify-between hidden">
            <span id="user-info" class="text-sm font-medium text-gray-400"></span>
            <button id="sign-out-button" class="text-sm text-red-400 hover:underline">
                (Sign Out)
            </button>
        </div>
        <button id="sign-in-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 mb-4">
            Sign In with Google
        </button>

        <div id="messages-container" class="flex-grow overflow-auto p-4 bg-gray-800 rounded-lg shadow-inner border border-gray-700 space-y-4">
            <div class="text-center text-gray-400 p-8">Loading posts...</div>
        </div>

        <form id="post-form" class="flex space-x-2 mt-4 hidden">
            <input id="message-input" type="text" placeholder="Start a new discussion topic..." class="flex-grow p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-green-400">
                Post
            </button>
        </form>
    </div>
</body>
</html>
